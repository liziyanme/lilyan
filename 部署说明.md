# LZY's Diary — 部署到 Vercel 说明

部署后可在手机、平板、电脑多端访问，同一账号多设备同时登录。

---

## 上架清单（按顺序做）

| 步骤 | 做什么 |
|------|--------|
| 1 | 本地把最新代码推送到 GitHub（见下方「推送到 GitHub」） |
| 2 | Vercel 从 GitHub 导入项目并部署（见「部署到 Vercel」） |
| 3 | Supabase 里配置登录回调域名（见「Supabase 配置」） |
| 4 | 要用子域名时：Vercel 添加域名 + 域名商做 CNAME + Supabase 加子域名（见「用子域名访问」） |

---

## 部署前检查

1. **Supabase 建表**：在 Supabase → SQL Editor 执行：
   - `supabase-schema.sql`（主表）
   - `supabase-rls-auth.sql`（登录隔离）
   - `supabase-comment.sql`（评论表，可选）
   - `supabase-notebook.sql`（日记本：写日记时可选择不同本子，可选）
   - `supabase-draft.sql`（草稿箱：未写完可保存为草稿，可选）
2. **Storage 桶**：Supabase → Storage → 新建 `diary-images` 公开桶
3. **Confirm email**：建议关闭（Supabase → Auth → Email → Confirm email 关）

---

## 1. 推送到 GitHub

**重要**：你本地刚做的改动（云相册放大、删除账号等）还没同步到 GitHub。Vercel 是从 GitHub 拉代码部署的，所以要先推上去。

在项目根目录（`c:\diary`）打开终端（PowerShell 或 CMD），执行：

```bash
git add -A
git commit -m "feat: 云相册页面内放大、删除账号、访客、日记本草稿等"
git push
```

- 如果还没连过 GitHub：先到 [GitHub](https://github.com) 新建仓库，再执行：
  ```bash
  git remote add origin https://github.com/你的用户名/仓库名.git
  git branch -M main
  git push -u origin main
  ```
- 推送时如果提示登录，用 GitHub 账号在浏览器里授权即可。

---

## 2. 部署到 Vercel

1. 打开 [vercel.com](https://vercel.com)，用 **GitHub 登录**
2. 点 **Add New** → **Project**
3. 在列表里选你已导入的仓库（例如 `liziyanme/lilyan` 或你的仓库名），点 **Import**
4. **Configure Project** 页面：
   - **Root Directory** 保持默认（一般是空的）
   - **Environment Variables** 点开，添加两条：
     - 名称 `NEXT_PUBLIC_SUPABASE_URL`，值 = 你的 Supabase 项目 URL（在 Supabase → Settings → API 里复制）
     - 名称 `NEXT_PUBLIC_SUPABASE_ANON_KEY`，值 = 你的 anon 公钥（eyJ 开头，同一页复制）
5. 点 **Deploy**，等一两分钟
6. 部署成功后，Vercel 会给你一个地址，例如 `lilyan.vercel.app`，点进去就能打开站点

---

## 3. Supabase 配置

部署成功后 Vercel 会给你一个域名（如 `lzy-diary.vercel.app`）。

1. 打开 [Supabase Dashboard](https://supabase.com/dashboard) → 你的项目
2. **Authentication** → **URL Configuration**
3. **Site URL** 填：`https://你的vercel域名.vercel.app`
4. **Redirect URLs** 添加：
   - `https://你的vercel域名.vercel.app/**`
   - `http://localhost:3000/**`（本地开发保留）

---

## 4. 用子域名访问（绑定自己的子域名）

要用自己的子域名（例如 `diary.你的主域名.com`）访问日记站，按下面做：

### 4.1 在 Vercel 里添加域名

1. 登录 [vercel.com](https://vercel.com)，进入你的项目（从 GitHub 导入的那个）
2. 顶部点 **Settings** → 左侧点 **Domains**
3. 在 **Domain** 输入框里填你的子域名，例如：`diary.你的主域名.com`
4. 点 **Add**，Vercel 会显示需要做的解析方式（一般是 **CNAME**）

### 4.2 在域名服务商做解析

1. 打开你买域名的平台（阿里云、腾讯云、Cloudflare、GoDaddy 等）
2. 找到「DNS 解析」/「域名解析」/「DNS Records」
3. 新增一条记录：
   - **类型**：选 **CNAME**
   - **主机记录**：填子域名前缀（例如用 `diary.xxx.com` 就填 `diary`；若 Vercel 写的是 `diary.你的主域名.com`，主机记录就填 `diary`）
   - **记录值**：填 Vercel 提示的那串，一般是 `cname.vercel-dns.com` 或项目专属的 `xxx.vercel.app`
4. 保存，等几分钟到几十分钟生效（有的服务商很快）

### 4.3 在 Supabase 里加上子域名

解析生效后（Vercel 的 Domains 里该域名会显示为有效）：

1. 打开 [Supabase Dashboard](https://supabase.com/dashboard) → 你的项目
2. **Authentication** → **URL Configuration**
3. **Site URL** 改成你的子域名，例如：`https://diary.你的主域名.com`
4. **Redirect URLs** 里添加：
   - `https://diary.你的主域名.com/**`
   - 保留原来的 `https://xxx.vercel.app/**` 和 `http://localhost:3000/**` 也可以

保存后，用子域名打开网站即可登录使用。

---

## 5. 多设备使用

部署完成后，用手机、平板、电脑浏览器打开你的网站，同一个账号登录，数据会同步。

---

## 6. 访客统计（可选）

项目已内置访客记录：每次页面访问会向 Supabase 的 `visitor` 表写入一条记录（IP、User-Agent、访问路径）。在 Supabase → **Table Editor** → **visitor** 可查看。若未执行过 `supabase-schema.sql`，则无此表，不影响其他功能。

---

## 常见问题

- **登录失败**：检查 Supabase → Auth → URL Configuration 是否添加了 Vercel 域名
- **评论不显示**：在 Supabase SQL Editor 执行 `supabase-comment.sql` 创建评论表
